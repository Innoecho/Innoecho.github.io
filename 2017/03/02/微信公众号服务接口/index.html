<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>微信公众号服务接口 | InnoBlog</title>
  <meta name="author" content="Innoecho">
  
  <meta name="description" content="Innoecho&#39;s Blog">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="微信公众号服务接口"/>
  <meta property="og:site_name" content="InnoBlog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/img/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="InnoBlog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  


</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">InnoBlog</a></h1>
  <h2><a href="/">May The Force Be With You</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2017-03-02T02:33:10.000Z"><a href="/2017/03/02/微信公众号服务接口/">2017-03-02</a></time>
      
      
  
    <h1 class="title">微信公众号服务接口</h1>
  

    </header>
    <div class="entry">
      
        <p>利用Python建立简单的微信公众号服务接口<br><a id="more"></a></p>
<h2 id="在SAE上搭建服务"><a href="#在SAE上搭建服务" class="headerlink" title="在SAE上搭建服务"></a>在SAE上搭建服务</h2><p>在<a href="http://sae.sina.com.cn/" target="_blank" rel="external">SAE</a>注册登陆后，创建新的应用，填写二级域名，<strong>记下这个地址</strong>，选择空的Python应用，因为一直用的Git，所以顺理成章的选了Git</p>
<h3 id="在本地初始化仓库并配置远程仓库"><a href="#在本地初始化仓库并配置远程仓库" class="headerlink" title="在本地初始化仓库并配置远程仓库"></a>在本地初始化仓库并配置远程仓库</h3><pre><code>git init
git remote add sae https://git.sinacloud.com/innoechowechat
</code></pre><h3 id="代码框架"><a href="#代码框架" class="headerlink" title="代码框架"></a>代码框架</h3><p>首先是config.yaml</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">name: InnoechoWechat</div><div class="line">version: <span class="number">1</span></div><div class="line"></div><div class="line">libraries:</div><div class="line">- name: webpy </div><div class="line">  version: <span class="string">"0.36"</span></div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<p>接下来是index.wsgi</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sae</div><div class="line"><span class="keyword">import</span> web</div><div class="line"></div><div class="line">sae.add_vendor_dir(<span class="string">'vendor'</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> WechatInterface <span class="keyword">import</span> WechatInterface</div><div class="line"></div><div class="line">urls = (</div><div class="line"><span class="string">'/wechat'</span>,<span class="string">'WechatInterface'</span></div><div class="line">)</div><div class="line"></div><div class="line">app_root = os.path.dirname(__file__)</div><div class="line">templates_root = os.path.join(app_root, <span class="string">'templates'</span>)</div><div class="line">render = web.template.render(templates_root)</div><div class="line"></div><div class="line">app = web.application(urls, globals()).wsgifunc()        </div><div class="line">application = sae.create_wsgi_app(app)</div></pre></td></tr></table></figure>
<p>然后我们需要创建WechatInterface类来响应请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">import</span> hashlib</div><div class="line"><span class="keyword">import</span> web</div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatInterface</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.app_root = os.path.dirname(__file__)</div><div class="line">        self.templates_root = os.path.join(self.app_root, <span class="string">'templates'</span>)</div><div class="line">        self.render = web.template.render(self.templates_root)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GET</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment">#获取输入参数</span></div><div class="line">        data = web.input()</div><div class="line">        signature = data.signature</div><div class="line">        timestamp = data.timestamp</div><div class="line">        nonce = data.nonce</div><div class="line">        echostr = data.echostr</div><div class="line">        <span class="comment">#微信设置的token</span></div><div class="line">        token = <span class="string">"000400"</span> </div><div class="line">        <span class="comment">#字典序排序</span></div><div class="line">        list = [token,timestamp,nonce]</div><div class="line">        list.sort()</div><div class="line">        sha1 = hashlib.sha1()</div><div class="line">        map(sha1.update,list)</div><div class="line">        hashcode = sha1.hexdigest()</div><div class="line">        <span class="comment">#sha1加密算法        </span></div><div class="line"></div><div class="line">        <span class="comment">#如果是来自微信的请求，则回复echostr</span></div><div class="line">        <span class="keyword">if</span> hashcode == signature:</div><div class="line">            <span class="keyword">return</span> echostr</div></pre></td></tr></table></figure>
<p>至此代码框架搭建完毕</p>
<h3 id="部署代码"><a href="#部署代码" class="headerlink" title="部署代码"></a>部署代码</h3><p>按照下面的操作，将代码部署到SAE</p>
<pre><code>git add .
git commit -m &quot;Test&quot;
git push sae master:1
</code></pre><h2 id="配置微信公众平台"><a href="#配置微信公众平台" class="headerlink" title="配置微信公众平台"></a>配置微信公众平台</h2><p>在<a href="http://mp.weixin.qq.com" target="_blank" rel="external">微信公众平台</a>注册登陆后，选择<strong>开发</strong>选项卡中的基本配置，然后修改服务器配置。</p>
<pre><code>URL = http://innoechowechat.applinzi.com/wechat
Token = 000400
</code></pre><p>这两个需要与SAE上的设置保持一致，URL即服务的地址，即SAE的应用地址+服务地址，Token则相当于密码，随意取即可。</p>
<p>正常提交之后，微信公众号接收到的信息就会被转发到SAE上的服务上面，但是此时这个服务并没有任何作用，仅能通过微信的认证而已</p>
<h2 id="添加echo服务"><a href="#添加echo服务" class="headerlink" title="添加echo服务"></a>添加echo服务</h2><p>在WechatInterface类中添加POST方法（<strong>记得import相关的依赖</strong>）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">POST</span><span class="params">(self)</span>:</span>   </div><div class="line">    <span class="comment">#获得post来的数据     </span></div><div class="line">    str_xml = web.data()</div><div class="line">    <span class="comment">#进行XML解析</span></div><div class="line">    xml = etree.fromstring(str_xml)</div><div class="line">    <span class="comment">#获得用户所输入的内容</span></div><div class="line">    content = xml.find(<span class="string">"Content"</span>).text</div><div class="line">    msgType = xml.find(<span class="string">"MsgType"</span>).text</div><div class="line">    fromUser = xml.find(<span class="string">"FromUserName"</span>).text</div><div class="line">    toUser = xml.find(<span class="string">"ToUserName"</span>).text</div><div class="line">    <span class="keyword">return</span> self.render.reply_text(fromUser,toUser,int(time.time()),content)</div></pre></td></tr></table></figure>
<p>另外还需要在templates目录下创建reply_text.xml模板文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$def with (toUser,fromUser,createTime,content)</div><div class="line"><span class="tag">&lt;<span class="name">xml</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ToUserName</span>&gt;</span>&lt;![CDATA[$toUser]]&gt;<span class="tag">&lt;/<span class="name">ToUserName</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">FromUserName</span>&gt;</span>&lt;![CDATA[$fromUser]]&gt;<span class="tag">&lt;/<span class="name">FromUserName</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CreateTime</span>&gt;</span>$createTime<span class="tag">&lt;/<span class="name">CreateTime</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">MsgType</span>&gt;</span>&lt;![CDATA[text]]&gt;<span class="tag">&lt;/<span class="name">MsgType</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Content</span>&gt;</span>&lt;![CDATA[$content]]&gt;<span class="tag">&lt;/<span class="name">Content</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></div></pre></td></tr></table></figure>
<p>简单的echo服务搭建完毕～</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Python/">Python</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/Python/">Python</a>, <a href="/tags/微信/">微信</a>, <a href="/tags/公众号/">公众号</a>
  </div>

        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>

  
      <div id="fb-root"></div>
<script>
  (function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=123456789012345";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));
</script>

<div class="fb-comments" data-href="http://yoursite.com/2017/03/02/微信公众号服务接口/index.html" data-num-posts="5" data-width="840" data-colorscheme="light"></div>
      
  
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:innoecho.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Android/">Android</a><small>2</small></li>
  
    <li><a href="/categories/Hexo/">Hexo</a><small>1</small></li>
  
    <li><a href="/categories/Python/">Python</a><small>1</small></li>
  
    <li><a href="/categories/Sublime/">Sublime</a><small>1</small></li>
  
    <li><a href="/categories/UAV/">UAV</a><small>2</small></li>
  
    <li><a href="/categories/Ubuntu/">Ubuntu</a><small>2</small></li>
  
  </ul>
</div>


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Android/" style="font-size: 10px;">Android</a> <a href="/tags/Apt-get/" style="font-size: 10px;">Apt-get</a> <a href="/tags/Compile/" style="font-size: 10px;">Compile</a> <a href="/tags/Gradle/" style="font-size: 10px;">Gradle</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/PixHawk/" style="font-size: 10px;">PixHawk</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Sublime/" style="font-size: 10px;">Sublime</a> <a href="/tags/Theme/" style="font-size: 10px;">Theme</a> <a href="/tags/UAV/" style="font-size: 10px;">UAV</a> <a href="/tags/Ubuntu/" style="font-size: 20px;">Ubuntu</a> <a href="/tags/VPN，XX-Net/" style="font-size: 10px;">VPN，XX-Net</a> <a href="/tags/公众号/" style="font-size: 10px;">公众号</a> <a href="/tags/微信/" style="font-size: 10px;">微信</a> <a href="/tags/蓝牙/" style="font-size: 10px;">蓝牙</a>
  </div>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2017 Innoecho
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>
