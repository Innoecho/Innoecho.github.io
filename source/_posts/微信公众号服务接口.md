---
title: 微信公众号服务接口
date: 2017-03-02 10:33:10
tags: [Python, 微信, 公众号]
categories: Python
---

利用Python建立简单的微信公众号服务接口
<!-- more -->

## 在SAE上搭建服务

在[SAE](http://sae.sina.com.cn/)注册登陆后，创建新的应用，填写二级域名，**记下这个地址**，选择空的Python应用，因为一直用的Git，所以顺理成章的选了Git

### 在本地初始化仓库并配置远程仓库

    git init
    git remote add sae https://git.sinacloud.com/innoechowechat

### 代码框架

首先是config.yaml

```python
name: InnoechoWechat
version: 1

libraries:
- name: webpy 
  version: "0.36"

...
```

接下来是index.wsgi

```python
import os
import sae
import web

sae.add_vendor_dir('vendor')

from WechatInterface import WechatInterface

urls = (
'/wechat','WechatInterface'
)

app_root = os.path.dirname(__file__)
templates_root = os.path.join(app_root, 'templates')
render = web.template.render(templates_root)

app = web.application(urls, globals()).wsgifunc()        
application = sae.create_wsgi_app(app)
```

然后我们需要创建WechatInterface类来响应请求

```python
# -*- coding: utf-8 -*-
import hashlib
import web
import os

class WechatInterface:

    def __init__(self):
        self.app_root = os.path.dirname(__file__)
        self.templates_root = os.path.join(self.app_root, 'templates')
        self.render = web.template.render(self.templates_root)

    def GET(self):
        #获取输入参数
        data = web.input()
        signature = data.signature
        timestamp = data.timestamp
        nonce = data.nonce
        echostr = data.echostr
        #微信设置的token
        token = "000400" 
        #字典序排序
        list = [token,timestamp,nonce]
        list.sort()
        sha1 = hashlib.sha1()
        map(sha1.update,list)
        hashcode = sha1.hexdigest()
        #sha1加密算法        

        #如果是来自微信的请求，则回复echostr
        if hashcode == signature:
            return echostr
```

至此代码框架搭建完毕

### 部署代码

按照下面的操作，将代码部署到SAE

    git add .
    git commit -m "Test"
    git push sae master:1

## 配置微信公众平台

在[微信公众平台](http://mp.weixin.qq.com)注册登陆后，选择**开发**选项卡中的基本配置，然后修改服务器配置。

    URL = http://innoechowechat.applinzi.com/wechat
    Token = 000400

这两个需要与SAE上的设置保持一致，URL即服务的地址，即SAE的应用地址+服务地址，Token则相当于密码，随意取即可。

正常提交之后，微信公众号接收到的信息就会被转发到SAE上的服务上面，但是此时这个服务并没有任何作用，仅能通过微信的认证而已

## 添加echo服务

在WechatInterface类中添加POST方法（**记得import相关的依赖**）

```python
def POST(self):   
    #获得post来的数据     
    str_xml = web.data()
    #进行XML解析
    xml = etree.fromstring(str_xml)
    #获得用户所输入的内容
    content = xml.find("Content").text
    msgType = xml.find("MsgType").text
    fromUser = xml.find("FromUserName").text
    toUser = xml.find("ToUserName").text
    return self.render.reply_text(fromUser,toUser,int(time.time()),content)
```

另外还需要在templates目录下创建reply_text.xml模板文件

```xml
$def with (toUser,fromUser,createTime,content)
<xml>
<ToUserName><![CDATA[$toUser]]></ToUserName>
<FromUserName><![CDATA[$fromUser]]></FromUserName>
<CreateTime>$createTime</CreateTime>
<MsgType><![CDATA[text]]></MsgType>
<Content><![CDATA[$content]]></Content>
</xml>
```

简单的echo服务搭建完毕～